# Employee Onboarding Demo Walkthrough

This guide walks through the Employee Onboarding sample playbook end-to-end,
demonstrating AI-powered content generation, real API integrations (Gmail,
Slack, Jira), and the full Skillmatic agentic architecture.

## Prerequisites

- Skillmatic Electron app running and authenticated
- Organization created with at least one member
- **AI API Key configured** — Settings > AI Config > set Anthropic API key
- **OAuth connections active:**
  - **Gmail** connected (for email delivery)
  - **Slack** connected (for welcome message posting)
  - **Jira** connected (for onboarding task creation)
- All 4 step agent images built and pushed to Artifact Registry:
  - `step-email-drafter:latest`
  - `step-account-provisioner:latest`
  - `step-calendar-manager:latest`
  - `step-report-generator:latest`
- Employee Onboarding playbook synced to Firestore catalog
- GKE Autopilot cluster running in `skillmatic-ea1ab` project

### Token Propagation

When you configure the AI API key and connect OAuth services in the Electron
app, the tokens are automatically synced to Firestore at
`orgs/{orgId}/secrets/`. The step agent containers on GKE read these tokens
via firebase-admin (Admin SDK) at runtime. No manual token copy is needed.

You can verify token sync status via the Secrets Status API, or manually
trigger a re-sync if tokens were configured before the sync feature was added.

## Step-by-Step Demo

### 1. Launch the Playbook

1. Navigate to **Playbooks** in the sidebar
2. Find **"Employee Onboarding"** in the catalog (category: HR)
3. Click **"Run Playbook"**
4. Fill in the trigger inputs:
   - **New Hire Name**: `Jane Smith`
   - **New Hire Email**: `jane.smith@acme.com`
   - **Manager Email**: `bob.jones@acme.com`
   - **Start Date**: `2025-04-01`
5. Click **"Launch"**

**Expected:** The app navigates to the Runs dashboard. A new run appears
with status "running".

### 2. Watch Parallel Step Execution

1. Click on the new run to open the detail panel
2. Observe the **Steps** section — both steps should start simultaneously:
   - **Draft Welcome Email** (welcome-email) — status: running
   - **Provision Accounts** (account-setup) — status: running
   - **Schedule Onboarding Meetings** (schedule-meetings) — status: pending (waiting for 1+2)
   - **Generate Onboarding Report** (onboarding-summary) — status: pending (waiting for 3)

**Expected:** The event timeline shows `step_started` events for both step 1
and step 2, confirming parallel execution. You should also see `agent_thinking`
events as the agents call Claude to generate content.

### 3. Answer the AI-Generated Question

1. In the event timeline, a **purple Question card** appears from the email drafter.
   The question is **AI-generated by Claude** — contextual to the specific onboarding:
   > (Claude generates a question about special topics to include in the email)
2. Type an answer, e.g.: `Please mention the team offsite on April 10th and our casual dress code`
3. Click **"Submit"**

**Expected:** The question card shows "Answered by your-email@..." and the
email drafter resumes (creates a new K8s Job via `onInputReceived`).

### 4. Approve the AI-Generated Account Provisioning Plan

1. An **amber Approval card** appears from the account provisioner showing
   the **AI-generated provisioning plan** with accounts to provision
2. Review the plan — Claude generates it based on the new hire's details
3. Click **"Approve"**

**Expected:** The approval card shows "Approved by your-email@..." and the
account provisioner resumes. You should see events for:
- Slack welcome message posted to #general
- Jira onboarding task created in the HR project

### 5. Review and Approve the AI-Generated Welcome Email

1. Another **amber Approval card** appears from the email drafter with the
   **AI-generated email draft** (Claude wrote it incorporating your special topics)
2. Options:
   - **Approve** — accept and send via Gmail API
   - **Revise** — click "Revise", edit the text, then submit
   - **Reject** — reject the draft (email not sent)
3. Click **"Approve"** (or revise if you want to test that flow)

**Expected:** On approval, the agent sends the email via Gmail API.
The event timeline shows a `gmail_send` tool use event with the message ID.
Both step 1 and step 2 complete with green checkmarks.

### 6. Watch DAG Dependency Gating

1. Once **both** steps 1 and 2 complete, step 3 (Schedule Meetings)
   automatically starts
2. The orchestrator detects both dependencies are satisfied and launches
   the calendar-manager Job
3. Claude generates a structured JSON schedule, then creates real Google Calendar events

**Expected:** Step 3 runs without any human interaction (exception_only
approval). You see `agent_thinking` events as Claude generates the schedule,
then `gcal_batch_create` tool use events as calendar events are created,
then a `file_ready` event for `meeting-schedule.md`.

### 7. Watch AI Report Generation

1. After step 3 completes, step 4 (Generate Report) automatically starts
2. The report-generator reads all step results and file metadata from
   Firestore, then Claude compiles a narrative executive report

**Expected:** Step 4 shows `agent_thinking` events as Claude analyzes the
results. Completes with a `file_ready` event for `onboarding-report.md`.

### 8. Download Artifacts

1. Look at the **Files** section in the detail panel
2. You should see 4 files:
   - `welcome-email.md` — the AI-drafted welcome email (with Gmail delivery status)
   - `account-provisioning.md` — the AI-generated plan (with Slack/Jira results)
   - `meeting-schedule.md` — the AI-generated week-1 meeting schedule (with Google Calendar links)
   - `onboarding-report.md` — the AI-compiled executive summary
3. Click any file to download it

### 9. Verify Real API Actions

1. **Gmail**: Check the new hire's inbox — the welcome email should be there
2. **Slack**: Check #general — a welcome message should be posted
3. **Jira**: Check the HR project — an onboarding task should be created
4. **Google Calendar**: Check the new hire's calendar — 12-15 onboarding meetings should appear
5. The `account-provisioning.md` artifact lists Slack/Jira API results
6. The `meeting-schedule.md` artifact lists Google Calendar event links

### 10. Verify Completion

1. The run status should show **"completed"**
2. The event timeline should contain **40+ events** including:
   - `playbook_started` / `playbook_completed`
   - `step_started` / `step_completed` for all 4 steps
   - Multiple `agent_thinking` events (Claude API calls)
   - `agent_tool_use` events for Gmail, Slack, Jira, and Google Calendar
   - `progress` events with percentage updates
   - `question` event from email drafter
   - `approval_request` events from email drafter and account provisioner
   - `file_ready` events for all 4 artifacts
3. The runs list should show the run with a "completed" badge

### 11. Multi-User Monitoring (Optional)

1. Open a second instance of the Electron app (or have a colleague open theirs)
2. Navigate to the same run
3. Both users should see:
   - Events streaming in real-time (including AI thinking events)
   - When one user answers a question, the other sees "Answered by user@..."
   - Submit buttons are disabled for already-answered questions
   - The runs list updates in real-time without manual refresh

## Features Exercised

| Feature | Where It's Demonstrated |
|---------|------------------------|
| **AI content generation** | All 4 agents use Claude API for content |
| **Gmail API integration** | Email drafter sends welcome email |
| **Slack API integration** | Account provisioner posts welcome to #general |
| **Jira API integration** | Account provisioner creates onboarding task |
| **Google Calendar API** | Calendar manager creates 12-15 real calendar events |
| **Token propagation** | OAuth tokens synced from Electron app to GKE via Firestore |
| Template hydration | Variables resolved in PLAYBOOK.md (company_name, new_hire_name, etc.) |
| Parallel execution | Steps 1+2 start simultaneously |
| DAG dependency gating | Step 3 waits for 1+2; Step 4 waits for 3 |
| HITL question (free_text) | Email drafter asks AI-generated question about special topics |
| review_and_edit approval | Email drafter shows AI-generated editable draft |
| approve_only approval | Account provisioner shows AI-generated plan for confirmation |
| exception_only (auto) | Calendar manager + report generator run unattended |
| 3-phase checkpoint/resume | Email drafter: question -> answer -> approval -> Gmail send |
| 2-phase checkpoint/resume | Account provisioner: approval -> Slack + Jira actions |
| File generation + Storage | All 4 agents upload markdown reports |
| Real API integrations | Gmail send, Slack post, Jira issue, Google Calendar events |
| Multi-user monitoring | Real-time events, inputs attribution, dedup |
| Abort handling | Can abort run at any point (tested separately) |

## Troubleshooting

- **Steps don't start:** Check GKE cluster is running and Artifact Registry images exist
- **"AI API key not configured" error:** Ensure AI key is set in Settings > AI Config and synced to Firestore
- **"Gmail/Slack/Jira OAuth token not found" error:** Ensure connections are active in the Connections panel. Try the manual sync-all button.
- **Gmail send fails with 401:** OAuth token may have expired. Reconnect Gmail in the Electron app.
- **Calendar events not created:** Ensure Gmail connection includes `calendar.events` scope. May need to reconnect Gmail to pick up the new scope.
- **Slack post fails:** Verify the bot has permission to post in #general. Check OAuth scopes include `chat:write`.
- **Jira create fails:** Verify Jira OAuth scopes include project access. Check that an "HR" project exists.
- **Question/approval cards don't appear:** Check Firestore real-time subscriptions in browser DevTools
- **Files not downloadable:** Verify Firebase Storage bucket permissions
- **Run stuck as "running":** Check step agent pod logs via `kubectl logs -n skillmatic`
